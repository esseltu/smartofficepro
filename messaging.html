<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - SmartOffice Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!--
        messaging.html
        Purpose: Employee messaging and direct communication platform.
        Structure: sidebar, message list panel, chat view, message composer.
        Notes: Enables real-time messaging between employees and department channels with read status tracking.
    -->
    <div class="wrapper">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-building fa-lg"></i>
                <h3>SmartOffice</h3>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="employees.html"><i class="fas fa-users"></i> Employees</a></li>
                <li><a href="attendance.html"><i class="fas fa-clock"></i> Attendance</a></li>
                <li><a href="leaves.html"><i class="fas fa-calendar-minus"></i> Leaves</a></li>
                <li><a href="documents.html"><i class="fas fa-file-alt"></i> Documents</a></li>
                <li><a href="finance.html"><i class="fas fa-dollar-sign"></i> Finance</a></li>
                <li><a href="messaging.html"><i class="fas fa-comments"></i> Messages</a></li>
                <li><a href="tasks.html"><i class="fas fa-tasks"></i> Tasks</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="user-info">
                    <span>User Name</span>
                    <img src="https://ui-avatars.com/api/?name=User+Name&background=0D8ABC&color=fff" alt="User">
                </div>
            </header>

            <div class="messaging-container">
                <!-- Message List (Conversations) -->
                <div class="message-list-panel">
                    <div class="message-list-header">
                        <h3>Messages</h3>
                        <button class="btn btn-sm btn-primary" onclick="openNewMessageModal()">
                            <i class="fas fa-plus"></i> New
                        </button>
                    </div>
                    <div class="search-bar" style="margin-bottom: 15px;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchConversations" placeholder="Search conversations..." onkeyup="filterConversations()">
                    </div>
                    <div id="conversationsList" class="conversations-list">
                        <!-- Conversations populated by JS -->
                    </div>
                </div>

                <!-- Chat View -->
                <div class="chat-panel">
                    <div id="noChatSelected" class="no-chat-selected" style="display: flex;">
                        <i class="fas fa-comments"></i>
                        <p>Select a conversation to start messaging</p>
                    </div>

                    <div id="chatView" class="chat-view" style="display: none;">
                        <div class="chat-header">
                            <div>
                                <h3 id="chatTitle">Conversation</h3>
                                <p id="chatSubtitle" class="chat-subtitle">Last message timestamp</p>
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="viewConversationInfo()">
                                <i class="fas fa-info-circle"></i> Info
                            </button>
                        </div>

                        <div id="messagesArea" class="messages-area">
                            <!-- Messages populated by JS -->
                        </div>

                        <div class="message-composer">
                            <form onsubmit="sendMessage(event)">
                                <div class="composer-input-group">
                                    <textarea id="messageInput" placeholder="Type a message..." rows="2" required></textarea>
                                    <button type="submit" class="btn btn-primary btn-icon" title="Send message">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div id="newMessageModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleModal('newMessageModal', false)">&times;</span>
            <h3 style="margin-bottom: 20px;">New Message</h3>
            <form id="newMessageForm">
                <div class="form-group">
                    <label>Recipient</label>
                    <select id="recipientSelect" class="form-control" required>
                        <option value="">-- Select Employee --</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="newMessageText" class="form-control" rows="4" placeholder="Type your message..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Send Message</button>
            </form>
        </div>
    </div>

    <!-- Conversation Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleModal('infoModal', false)">&times;</span>
            <h3 style="margin-bottom: 20px;">Conversation Details</h3>
            <div id="infoContent" style="padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px;">
                <!-- Info populated by JS -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let currentConversationId = null;

        document.addEventListener('DOMContentLoaded', () => {
            populateRecipientSelect();
            loadConversations();
            document.getElementById('newMessageForm').addEventListener('submit', handleNewMessageSubmit);
        });

        function populateRecipientSelect() {
            const employees = db.get(DATA_KEYS.EMPLOYEES) || [];
            const currentUser = auth.getCurrentUser();
            const select = document.getElementById('recipientSelect');
            
            employees.forEach(emp => {
                if (emp.id !== currentUser.id) {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.name;
                    select.appendChild(option);
                }
            });
        }

        function loadConversations() {
            const currentUser = auth.getCurrentUser();
            const messages = db.get(DATA_KEYS.MESSAGES) || [];
            const employees = db.get(DATA_KEYS.EMPLOYEES) || [];

            // Group messages by conversation
            const conversations = {};
            messages.forEach(msg => {
                if (msg.senderId === currentUser.id || msg.recipientId === currentUser.id) {
                    const conversationKey = [msg.senderId, msg.recipientId].sort().join('|');
                    if (!conversations[conversationKey]) {
                        const otherUserId = msg.senderId === currentUser.id ? msg.recipientId : msg.senderId;
                        const otherUser = employees.find(e => e.id === otherUserId);
                        conversations[conversationKey] = {
                            id: conversationKey,
                            otherUser,
                            messages: [],
                            unreadCount: 0
                        };
                    }
                    conversations[conversationKey].messages.push(msg);
                    if (msg.recipientId === currentUser.id && !msg.read) {
                        conversations[conversationKey].unreadCount++;
                    }
                }
            });

            renderConversationsList(Object.values(conversations));
        }

        function renderConversationsList(conversations) {
            const list = document.getElementById('conversationsList');
            if (conversations.length === 0) {
                list.innerHTML = '<div class="no-conversations"><p>No conversations yet</p></div>';
                return;
            }

            // Sort by latest message
            conversations.sort((a, b) => {
                const lastA = a.messages[a.messages.length - 1]?.timestamp || 0;
                const lastB = b.messages[b.messages.length - 1]?.timestamp || 0;
                return new Date(lastB) - new Date(lastA);
            });

            list.innerHTML = conversations.map(conv => {
                const lastMsg = conv.messages[conv.messages.length - 1];
                const lastMsgTime = new Date(lastMsg.timestamp).toLocaleDateString();
                const preview = lastMsg.text.substring(0, 40) + (lastMsg.text.length > 40 ? '...' : '');
                const unreadClass = conv.unreadCount > 0 ? 'unread' : '';
                
                return `
                    <div class="conversation-item ${unreadClass}" onclick="selectConversation('${conv.id}', '${conv.otherUser.id}')">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(conv.otherUser.name)}&background=0D8ABC&color=fff" alt="${conv.otherUser.name}">
                        <div class="conversation-info">
                            <h4>${conv.otherUser.name}</h4>
                            <p class="preview">${preview}</p>
                        </div>
                        <div class="conversation-meta">
                            <span class="time">${lastMsgTime}</span>
                            ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterConversations() {
            const searchInput = document.getElementById('searchConversations').value.toLowerCase();
            const currentUser = auth.getCurrentUser();
            const messages = db.get(DATA_KEYS.MESSAGES) || [];
            const employees = db.get(DATA_KEYS.EMPLOYEES) || [];

            const conversations = {};
            messages.forEach(msg => {
                if (msg.senderId === currentUser.id || msg.recipientId === currentUser.id) {
                    const conversationKey = [msg.senderId, msg.recipientId].sort().join('|');
                    if (!conversations[conversationKey]) {
                        const otherUserId = msg.senderId === currentUser.id ? msg.recipientId : msg.senderId;
                        const otherUser = employees.find(e => e.id === otherUserId);
                        conversations[conversationKey] = {
                            id: conversationKey,
                            otherUser,
                            messages: [],
                            unreadCount: 0
                        };
                    }
                    conversations[conversationKey].messages.push(msg);
                    if (msg.recipientId === currentUser.id && !msg.read) {
                        conversations[conversationKey].unreadCount++;
                    }
                }
            });

            const filtered = Object.values(conversations).filter(conv =>
                conv.otherUser.name.toLowerCase().includes(searchInput)
            );

            renderConversationsList(filtered);
        }

        function selectConversation(conversationId, otherUserId) {
            currentConversationId = conversationId;
            const currentUser = auth.getCurrentUser();
            const messages = db.get(DATA_KEYS.MESSAGES) || [];
            const employees = db.get(DATA_KEYS.EMPLOYEES) || [];
            const otherUser = employees.find(e => e.id === otherUserId);

            // Get messages for this conversation
            const conversationMessages = messages.filter(msg =>
                (msg.senderId === currentUser.id && msg.recipientId === otherUserId) ||
                (msg.senderId === otherUserId && msg.recipientId === currentUser.id)
            );

            // Mark messages as read
            conversationMessages.forEach(msg => {
                if (msg.recipientId === currentUser.id && !msg.read) {
                    msg.read = true;
                }
            });
            db.set(DATA_KEYS.MESSAGES, messages);

            // Display chat
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('chatView').style.display = 'flex';
            document.getElementById('chatTitle').textContent = otherUser.name;
            document.getElementById('chatSubtitle').textContent = otherUser.dept + ' â€¢ ' + otherUser.position;

            renderMessages(conversationMessages, currentUser.id);
            loadConversations(); // Refresh conversation list to remove unread badges
        }

        function renderMessages(messages, currentUserId) {
            const area = document.getElementById('messagesArea');
            area.innerHTML = messages.map(msg => {
                const isOwn = msg.senderId === currentUserId;
                const msgTime = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return `
                    <div class="message ${isOwn ? 'sent' : 'received'}">
                        <div class="message-bubble">
                            <p>${msg.text}</p>
                            <span class="message-time">${msgTime}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            area.scrollTop = area.scrollHeight;
        }

        function sendMessage(event) {
            event.preventDefault();
            const currentUser = auth.getCurrentUser();
            const messageText = document.getElementById('messageInput').value.trim();

            if (!messageText) return;

            const messages = db.get(DATA_KEYS.MESSAGES) || [];
            const [userId1, userId2] = currentConversationId.split('|');
            const otherUserId = userId1 === currentUser.id ? userId2 : userId1;

            const newMessage = {
                id: Date.now().toString(),
                senderId: currentUser.id,
                recipientId: otherUserId,
                text: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };

            messages.push(newMessage);
            db.set(DATA_KEYS.MESSAGES, messages);

            document.getElementById('messageInput').value = '';
            selectConversation(currentConversationId, otherUserId);
        }

        function openNewMessageModal() {
            document.getElementById('newMessageForm').reset();
            toggleModal('newMessageModal', true);
        }

        function handleNewMessageSubmit(e) {
            e.preventDefault();
            const currentUser = auth.getCurrentUser();
            const recipientId = document.getElementById('recipientSelect').value;
            const messageText = document.getElementById('newMessageText').value;

            const messages = db.get(DATA_KEYS.MESSAGES) || [];
            const newMessage = {
                id: Date.now().toString(),
                senderId: currentUser.id,
                recipientId,
                text: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };

            messages.push(newMessage);
            db.set(DATA_KEYS.MESSAGES, messages);
            toggleModal('newMessageModal', false);
            loadConversations();
            
            const conversationId = [currentUser.id, recipientId].sort().join('|');
            selectConversation(conversationId, recipientId);
            showNotification('Message sent successfully', 'success');
        }

        function viewConversationInfo() {
            const employees = db.get(DATA_KEYS.EMPLOYEES) || [];
            const [userId1, userId2] = currentConversationId.split('|');
            const currentUser = auth.getCurrentUser();
            const otherUserId = userId1 === currentUser.id ? userId2 : userId1;
            const otherUser = employees.find(e => e.id === otherUserId);

            const info = `
                <p><strong>Name:</strong> ${otherUser.name}</p>
                <p><strong>Department:</strong> ${otherUser.dept}</p>
                <p><strong>Position:</strong> ${otherUser.position}</p>
                <p><strong>Email:</strong> ${otherUser.email}</p>
                <p><strong>Phone:</strong> ${otherUser.phone}</p>
            `;
            document.getElementById('infoContent').innerHTML = info;
            toggleModal('infoModal', true);
        }
    </script>
</body>
</html>
